name: Autonomous AI Agent Workflow

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - agent

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # 1. THINKERS: Run parallel analysis agents
  thinkers:
    name: "Thinker: ${{ matrix.specialist }}"
    runs-on: ubuntu-24.04-arm
    strategy:
      fail-fast: false
      matrix:
        specialist:
          - product-strategist
          - software-architect
          - reliability-engineer
          - quality-assurance
          - security-engineer
          - performance-engineer
          - database-architect
          - integration-engineer
          - ui-ux-engineer
          - devops-engineer
          - technical-writer
          - code-reviewer
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache Opencode CLI
        id: cache-opencode
        uses: actions/cache@v4
        with:
          path: ~/.npm-global
          key: ${{ runner.os }}-opencode-v1

      - name: Setup NPM Global Path
        run: |
          mkdir -p ~/.npm-global
          npm config set prefix '~/.npm-global'
          echo "$HOME/.npm-global/bin" >> $GITHUB_PATH

      - name: Install Opencode CLI
        if: steps.cache-opencode.outputs.cache-hit != 'true'
        run: npm install -g opencode

      - name: Run Specialist Agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }} # Assumes secret is set
        run: |
          echo "Running ${{ matrix.specialist }} specialist..."
          mkdir -p artifacts
          opencode run --agent .agent/prompts/${{ matrix.specialist }}.md --context . --output artifacts/${{ matrix.specialist }}.md

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: thinker-artifacts-${{ matrix.specialist }}
          path: artifacts/
          retention-days: 1

  # 2. SYNTHESIZER: Aggregate findings
  synthesizer:
    name: Synthesize Findings
    needs: thinkers
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup NPM Global Path
        run: |
          mkdir -p ~/.npm-global
          npm config set prefix '~/.npm-global'
          echo "$HOME/.npm-global/bin" >> $GITHUB_PATH

      - name: Install Opencode CLI
        run: npm install -g opencode # Fast if cached or uses same cache key strategy if we added it here

      - name: Download Specialist Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: thinker-artifacts-*
          path: thinker-data/
          merge-multiple: true

      - name: Synthesize
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Synthesizing findings..."
          mkdir -p workspace
          # Assuming a synthesizer prompt exists or handling via tailored command
          # For now, concatenating inputs and sending to a 'synthesizer' agent/prompt if it existed, 
          # OR just using a generic opencode command. 
          # Since we didn't define a synthesizer prompt file yet, I will simulate the command structure 
          # but note that a prompt file would be best. 
          # For this step, I'll stick to the plan's logic of using opencode.

          # Let's create a temporary synthesis prompt
          echo "Synthesize these findings into a plan:" > workspace/synth_prompt.md

          opencode run --agent workspace/synth_prompt.md --context thinker-data/ --output workspace/plan.md

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: synthesis-plan
          path: workspace/plan.md
          retention-days: 1

  # 3. PLANNER: Decide next steps
  planner:
    name: Planning Phase
    needs: synthesizer
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup NPM Global Path
        run: |
          mkdir -p ~/.npm-global
          npm config set prefix '~/.npm-global'
          echo "$HOME/.npm-global/bin" >> $GITHUB_PATH

      - name: Install Opencode CLI
        run: npm install -g opencode

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: synthesis-plan
          path: workspace/

      - name: Create Execution Plan
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Creating execution plan..."
          # Convert plan.md to execution json
          echo "Convert this plan to JSON execution tasks:" > workspace/planner_prompt.md
          opencode run --agent workspace/planner_prompt.md --context workspace/plan.md --output workspace/execution-tasks.json

      - name: Upload Execution Tasks
        uses: actions/upload-artifact@v4
        with:
          name: execution-plan
          path: workspace/execution-tasks.json

  # 4. EXECUTOR: Apply changes
  executor:
    name: Execute Changes
    needs: planner
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup NPM Global Path
        run: |
          mkdir -p ~/.npm-global
          npm config set prefix '~/.npm-global'
          echo "$HOME/.npm-global/bin" >> $GITHUB_PATH

      - name: Install Opencode CLI
        run: npm install -g opencode

      - name: Download Execution Plan
        uses: actions/download-artifact@v4
        with:
          name: execution-plan
          path: workspace/

      - name: Run Executors
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Executing changes..."
          opencode run --agent "implementor" --input workspace/execution-tasks.json --modify

      - name: Upload Changed Files
        uses: actions/upload-artifact@v4
        with:
          name: executor-changes
          path: src/ # Assuming opencode modifies files in src
          retention-days: 1

  # 5. MUTATOR: Commit and Merge safe changes
  mutator:
    name: Mutator & Merger
    needs: executor
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout Code (Full History)
        uses: actions/checkout@v4
        with:
          ref: agent
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "AI Agent"
          git config user.email "agent@bot.local"

      - name: Download Changes
        uses: actions/download-artifact@v4
        with:
          name: executor-changes
          path: applied_changes/

      - name: Apply and Commit
        run: |
          # Copy changes over
          cp -r applied_changes/* src/ || true

          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore(ai): applied autonomous changes [skip ci]"
            git pull --rebase origin agent
            git push origin agent
          fi
