name: Autonomous AI Agent Workflow

on:
  push:
    branches:
      - agent

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # 1. THINKERS: Run parallel analysis agents
  thinkers:
    name: "Thinker: ${{ matrix.specialist }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        specialist:
          - product-strategist
          - software-architect
          - reliability-engineer
          - quality-assurance
          - security-engineer
          - performance-engineer
          - database-architect
          - integration-engineer
          - ui-ux-engineer
          - devops-engineer
          - technical-writer
          - code-reviewer
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache Opencode CLI
        id: cache-opencode
        uses: actions/cache@v4
        with:
          path: ~/.npm-global
          key: ${{ runner.os }}-opencode-v1

      - name: Setup NPM Global Path
        run: |
          mkdir -p ~/.npm-global
          npm config set prefix '~/.npm-global'
          echo "$HOME/.npm-global/bin" >> $GITHUB_PATH

      - name: Install Opencode CLI
        if: steps.cache-opencode.outputs.cache-hit != 'true'
        run: npm install -g opencode-ai

      - name: Run Specialist Agent
        run: |
          echo "Running ${{ matrix.specialist }} specialist..."
          mkdir -p artifacts
          opencode run --model opencode/glm-4.7-free --share false "$(cat .agent/prompts/${{ matrix.specialist }}.md)" > artifacts/${{ matrix.specialist }}.md

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: thinker-artifacts-${{ matrix.specialist }}
          path: artifacts/
          retention-days: 1

  # 2. SYNTHESIZER: Aggregate findings
  synthesizer:
    name: Synthesize Findings
    needs: thinkers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup NPM Global Path
        run: |
          mkdir -p ~/.npm-global
          npm config set prefix '~/.npm-global'
          echo "$HOME/.npm-global/bin" >> $GITHUB_PATH

      - name: Install Opencode CLI
        run: npm install -g opencode

      - name: Download Specialist Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: thinker-artifacts-*
          path: thinker-data/
          merge-multiple: true

      - name: Synthesize
        run: |
          echo "Synthesizing findings..."
          mkdir -p workspace

          echo "Synthesize these findings into a plan:" > workspace/synth_prompt.md

          opencode run --model opencode/glm-4.7-free --share false "$(cat workspace/synth_prompt.md) Context: $(ls thinker-data/)" > workspace/plan.md

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: synthesis-plan
          path: workspace/plan.md
          retention-days: 1

  # 3. PLANNER: Decide next steps
  planner:
    name: Planning Phase
    needs: synthesizer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup NPM Global Path
        run: |
          mkdir -p ~/.npm-global
          npm config set prefix '~/.npm-global'
          echo "$HOME/.npm-global/bin" >> $GITHUB_PATH

      - name: Install Opencode CLI
        run: npm install -g opencode

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: synthesis-plan
          path: workspace/

      - name: Create Execution Plan
        run: |
          echo "Creating execution plan..."
          echo "Convert this plan to JSON execution tasks:" > workspace/planner_prompt.md
          opencode run --model opencode/glm-4.7-free --share false "$(cat workspace/planner_prompt.md) Plan: $(cat workspace/plan.md)" > workspace/execution-tasks.json

      - name: Upload Execution Tasks
        uses: actions/upload-artifact@v4
        with:
          name: execution-plan
          path: workspace/execution-tasks.json

  # 4. EXECUTOR: Apply changes
  executor:
    name: Execute Changes
    needs: planner
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup NPM Global Path
        run: |
          mkdir -p ~/.npm-global
          npm config set prefix '~/.npm-global'
          echo "$HOME/.npm-global/bin" >> $GITHUB_PATH

      - name: Install Opencode CLI
        run: npm install -g opencode-ai

      - name: Download Execution Plan
        uses: actions/download-artifact@v4
        with:
          name: execution-plan
          path: workspace/

      - name: Run Executors
        run: |
          echo "Executing changes..."
          opencode run --model opencode/glm-4.7-free --share false "Implement these tasks: $(cat workspace/execution-tasks.json)" > src/generated_changes.patch

      - name: Upload Changed Files
        uses: actions/upload-artifact@v4
        with:
          name: executor-changes
          path: src/generated_changes.patch
          retention-days: 1

  # 5. MUTATOR: Commit and Merge safe changes
  mutator:
    name: Mutator & Merger
    needs: executor
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code (Full History)
        uses: actions/checkout@v4
        with:
          ref: agent
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "AI Agent"
          git config user.email "agent@bot.local"

      - name: Download Changes
        uses: actions/download-artifact@v4
        with:
          name: executor-changes
          path: applied_changes/

      - name: Apply and Commit
        run: |
          # Copy changes over
          cp -r applied_changes/* src/ || true

          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore(ai): applied autonomous changes [skip ci]"
            git pull --rebase origin agent
            git push origin agent
          fi
